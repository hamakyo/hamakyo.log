# 画像最適化機能 実装計画書

## 1. 目的

当ブログのパフォーマンス向上、特にCore Web Vitalsの改善を目的とし、画像最適化機能を導入する。具体的には、以下の目標を達成する。

- ページの読み込み速度の向上
- Lighthouseスコアの改善
- 帯域幅使用量の削減

## 2. 現状の課題

現在、ブログ記事や各ページで使用されている画像は、最適化されずに元のサイズのまま配信されている。

- **対象ディレクトリ**:
    - `public/images/`
    - `src/content/blog/` 内のMarkdownファイルから参照される画像（主にNotionから同期されたもの）
- **問題点**:
    - ファイルサイズが大きく、ページの読み込みに時間がかかる。
    - WebPなどの次世代フォーマットが使われていない。
    - レスポンシブ対応が手動であり、デバイスごとに最適なサイズの画像が配信されていない。

## 3. 提案する解決策

Astro公式が提供する画像最適化機能 `astro:assets` を全面的に採用する。

### 3.1. 主な機能

- **ビルド時の自動最適化**: `sharp` ライブラリを利用し、画像を自動的に圧縮・リサイズする。
- **次世代フォーマットへの変換**: WebPやAVIF形式に自動で変換し、対応ブラウザに配信する。
- **`<Image />` コンポーネント**: 最適化された画像を簡単に利用するためのコンポーネント。`width`, `height`, `format` などを指定できる。
- **Markdownサポート**: AstroのMarkdownインテグレーションは `astro:assets` と連携し、Markdown内の画像パスを自動的に処理する。

### 3.2. 実装方針

1. **画像の保存場所の変更**:
   - 新規画像を保存するディレクトリを `public/` から `src/assets/` に変更する。
   - Notion同期スクリプト(`scripts/sync-notion.ts`)が画像をダウンロードする際の保存先を `public/images/notion/` から `src/assets/images/notion/` に変更する。

2. **コンポーネントの修正**:
   - `<img>` タグで画像を表示している箇所（例: `src/layouts/BlogPost.astro` のヒーロー画像）を、Astroの `<Image />` コンポーネントに置き換える。

3. **Markdownコンテンツの修正**:
   - Notion同期スクリプトを改修し、生成されるMarkdown内の画像パスが、`src/assets/` 内の画像を参照するように修正する。
   - 既存のMarkdownファイル内の画像パスも、新しいパス形式に更新する。

## 4. タスク分割

1. **[セットアップ]** `astro:assets` を有効化し、`src/assets/images/notion` ディレクトリを作成する。
2. **[スクリプト改修]** `scripts/sync-notion.ts` とその関連モジュール(`image-processor.ts`など)を修正し、画像の保存先とMarkdown内のパス生成ロジックを変更する。
3. **[レイアウト改修]** `src/layouts/BlogPost.astro` のヒーロー画像を `<Image />` コンポーネントを使うように修正する。
4. **[データ移行]** 既存の全Markdownファイルの画像パスを `public/` ベースから `src/assets/` ベースのパスに置換するスクリプトを作成し、実行する。
5. **[テスト]** ローカル環境で `pnpm run build` を実行し、画像が正しく最適化され、ページが問題なく表示されることを確認する。
6. **[ドキュメント]** `README.md` や `NOTION_SYNC_SETUP.md` に関連する変更点を追記する。

## 5. 懸念事項

- **既存記事への影響**: 多数の既存記事の画像パスを修正する必要があるため、漏れなく対応するための堅牢なスクリプト作成が重要になる。
- **Notion同期スクリプトの複雑化**: 画像処理ロジックの追加により、`scripts/sync-notion.ts` が複雑になる可能性があるため、処理を適切にモジュール分割する必要がある。
